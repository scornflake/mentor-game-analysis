<UserControl x:Class="Mentor.Uno.Views.AnalysisInputView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="using:Mentor.Uno"
             xmlns:views="using:Mentor.Uno.Views"
             xmlns:converters="using:Mentor.Uno.Converters"
             xmlns:models="using:Mentor.Core.Models">
  <UserControl.Resources>
    <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    <local:StringToBoolConverter x:Key="StringToBoolConverter"/>
    <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
  </UserControl.Resources>
  
  <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
          BorderThickness="1"
          CornerRadius="8"
          Padding="20"
          MaxWidth="420">
    <Border.Shadow>
      <ThemeShadow />
    </Border.Shadow>
    <ScrollViewer>
      <StackPanel Spacing="12">
      <!-- Game Name -->
      <StackPanel Spacing="8">
        <TextBlock Text="Game Name:" FontWeight="SemiBold"/>
        <TextBox Text="{x:Bind GameName, Mode=TwoWay}"
                 PlaceholderText="e.g., Warframe"
                 TextWrapping="NoWrap"/>
      </StackPanel>

      <!-- Image Selection -->
      <StackPanel Spacing="8">
        <TextBlock Text="Screenshot Image:" FontWeight="SemiBold"/>
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>
          <TextBox Grid.Column="0"
                   Text="{x:Bind ImageFileName, Mode=OneWay}"
                   PlaceholderText="Select an image file..."
                   IsReadOnly="True"
                   Margin="0,0,10,0">
            <ToolTipService.ToolTip>
              <ToolTip Content="{x:Bind ImagePath, Mode=OneWay}"
                       Visibility="{x:Bind ImagePath, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"/>
            </ToolTipService.ToolTip>
          </TextBox>
          <Button Grid.Column="1"
                  Content="Browse..."
                  Click="OnBrowseClick"
                  MinWidth="100"/>
        </Grid>
        <TextBlock Text="or take a screenshot"
                   FontSize="12"
                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                   HorizontalAlignment="Center"
                   FontStyle="Italic"/>
      </StackPanel>

      <!-- Prompt Input -->
      <StackPanel Spacing="8">
        <TextBlock Text="Analysis Prompt:" FontWeight="SemiBold"/>
        <TextBox Text="{x:Bind Prompt, Mode=TwoWay}"
                 PlaceholderText="What should I do next?"
                 AcceptsReturn="True"
                 MinHeight="60"
                 TextWrapping="Wrap"/>
      </StackPanel>

      <!-- Image Preview -->
      <StackPanel Spacing="4"
                  Visibility="{x:Bind ImageSource, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
        <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="8">
          <Image Source="{x:Bind ImageSource, Mode=OneWay}"
                 Stretch="Uniform"
                 HorizontalAlignment="Center"
                 VerticalAlignment="Center"
                 Tapped="OnImagePreviewTapped"/>
        </Border>
        
        <!-- Regular caption (hidden during validation) -->
        <TextBlock Text="{x:Bind ImageSourceCaption, Mode=OneWay}"
                   FontSize="12"
                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                   HorizontalAlignment="Center"
                   FontStyle="Italic"
                   Visibility="{x:Bind IsValidatingImage, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
        
        <!-- Validation progress (shown during validation) -->
        <StackPanel Orientation="Horizontal"
                    Spacing="8"
                    HorizontalAlignment="Center"
                    Visibility="{x:Bind IsValidatingImage, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
          <ProgressRing IsActive="True" Width="16" Height="16" VerticalAlignment="Center"/>
          <TextBlock Text="{x:Bind ValidationMessage, Mode=OneWay}"
                     FontSize="12"
                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                     FontStyle="Italic"
                     VerticalAlignment="Center"/>
        </StackPanel>
      </StackPanel>

      <!-- Provider Selection -->
      <StackPanel Spacing="8">
        <TextBlock Text="LLM Provider:" FontWeight="SemiBold"/>
        <ComboBox ItemsSource="{x:Bind Providers}"
                  SelectedItem="{x:Bind SelectedProvider, Mode=TwoWay}"
                  MinWidth="200"
                  HorizontalAlignment="Left"/>
      </StackPanel>

      <!-- Analyze Button -->
      <Button Content="Analyze Screenshot"
              Command="{x:Bind AnalyzeCommand}"
              HorizontalAlignment="Stretch"
              Padding="16,10"
              Style="{StaticResource AccentButtonStyle}"/>

      <!-- Progress Indicator -->
      <StackPanel Spacing="8"
                  Visibility="{x:Bind IsAnalyzing, Mode=OneWay}">
        <StackPanel Orientation="Horizontal"
                    Spacing="10"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
          <ProgressRing IsActive="True" Width="32" Height="32" Margin="8" Padding="8" VerticalAlignment="Center"/>
          <TextBlock Text="Analyzing..." FontStyle="Italic" VerticalAlignment="Center"/>
          <Button Content="Cancel"
                  Command="{x:Bind CancelAnalysisCommand}"
                  MinWidth="80"
                  VerticalAlignment="Center"/>
        </StackPanel>
        <TextBlock Text="{x:Bind AnalyzingMessage, Mode=OneWay}"
                   FontSize="12"
                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                   HorizontalAlignment="Center"
                   FontStyle="Italic"/>
        
        <!-- Job Progress View -->
        <views:JobProgressView AnalysisProgress="{x:Bind AnalysisProgress, Mode=OneWay}"
                               Margin="0,8,0,0"/>
      </StackPanel>
      </StackPanel>
    </ScrollViewer>
  </Border>
</UserControl>

