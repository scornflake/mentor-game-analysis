<Page x:Class="Mentor.Uno.MainPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:Mentor.Uno"
      xmlns:models="using:Mentor.Core.Models"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- Fixed Header -->
    <Grid Grid.Row="0" Padding="20,20,20,12">
      <TextBlock Text="Game Analysis"
                 Style="{StaticResource TitleTextBlockStyle}"
                 HorizontalAlignment="Left"/>
      <Button Content="⚙ Settings"
              Click="OnSettingsClick"
              HorizontalAlignment="Right"
              Style="{StaticResource TextBlockButtonStyle}"/>
    </Grid>

    <!-- Main Content Area -->
    <Grid Grid.Row="1" Padding="20,12,20,20">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="Auto"/>
        <ColumnDefinition Width="*"/>
      </Grid.ColumnDefinitions>

      <!-- Input Section -->
      <ScrollViewer Grid.Column="0" MaxWidth="400" Margin="0,0,20,0">
        <StackPanel Spacing="16">

          <!-- Game Name -->
          <StackPanel Spacing="8">
            <TextBlock Text="Game Name:" FontWeight="SemiBold"/>
            <TextBox Text="{x:Bind ViewModel.GameName, Mode=TwoWay}"
                     PlaceholderText="e.g., Warframe"
                     TextWrapping="NoWrap"/>
          </StackPanel>

          <!-- Image Selection -->
        <StackPanel Spacing="8">
          <TextBlock Text="Screenshot Image:" FontWeight="SemiBold"/>
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBox Grid.Column="0"
                     Text="{x:Bind ViewModel.ImageFileName, Mode=OneWay}"
                     PlaceholderText="Select an image file..."
                     IsReadOnly="True"
                     Margin="0,0,10,0">
              <ToolTipService.ToolTip>
                <ToolTip Content="{x:Bind ViewModel.ImagePath, Mode=OneWay}"
                         Visibility="{x:Bind ViewModel.ImagePath, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"/>
              </ToolTipService.ToolTip>
            </TextBox>
            <Button Grid.Column="1"
                    Content="Browse..."
                    Click="OnBrowseClick"
                    MinWidth="100"/>
          </Grid>
        </StackPanel>

        <!-- Prompt Input -->
        <StackPanel Spacing="8">
          <TextBlock Text="Analysis Prompt:" FontWeight="SemiBold"/>
          <TextBox Text="{x:Bind ViewModel.Prompt, Mode=TwoWay}"
                   PlaceholderText="What should I do next?"
                   AcceptsReturn="True"
                   MinHeight="60"
                   TextWrapping="Wrap"/>
        </StackPanel>

        <!-- Image Preview -->
        <StackPanel Spacing="4"
                    Visibility="{x:Bind ViewModel.ImageSource, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
          <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                  BorderThickness="1"
                  CornerRadius="4">
            <Image Source="{x:Bind ViewModel.ImageSource, Mode=OneWay}"
                   Stretch="Uniform"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"/>
          </Border>
          <TextBlock Text="{x:Bind ViewModel.ImageSourceCaption, Mode=OneWay}"
                     FontSize="12"
                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                     HorizontalAlignment="Center"
                     FontStyle="Italic"/>
        </StackPanel>

        <!-- Provider Selection -->
        <StackPanel Spacing="8">
          <TextBlock Text="LLM Provider:" FontWeight="SemiBold"/>
          <ComboBox ItemsSource="{x:Bind ViewModel.Providers}"
                    SelectedItem="{x:Bind ViewModel.SelectedProvider, Mode=TwoWay}"
                    MinWidth="200"
                    HorizontalAlignment="Left"/>
        </StackPanel>

        <!-- Analyze Button -->
        <Button Content="Analyze Screenshot"
                Command="{x:Bind ViewModel.AnalyzeCommand}"
                HorizontalAlignment="Stretch"
                Style="{StaticResource AccentButtonStyle}"/>

        <!-- Progress Indicator -->
        <StackPanel Orientation="Horizontal"
                    Spacing="10"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="{x:Bind ViewModel.IsAnalyzing, Mode=OneWay}">
          <ProgressRing IsActive="True" Width="32" Height="32" Margin="8" Padding="8" VerticalAlignment="Center"/>
          <TextBlock Text="Analyzing..." FontStyle="Italic" VerticalAlignment="Center"/>
          <Button Content="Cancel"
                  Command="{x:Bind ViewModel.CancelAnalysisCommand}"
                  MinWidth="80"
                  VerticalAlignment="Center"
                  Style="{StaticResource TextBlockButtonStyle}"/>
        </StackPanel>

          <!-- Error Message -->
          <InfoBar IsOpen="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
                   Severity="Error"
                   Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"/>
        </StackPanel>
      </ScrollViewer>

      <!-- Results Section -->
      <ScrollViewer Grid.Column="1" Visibility="{x:Bind ViewModel.Result, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
        <StackPanel Spacing="16">
          <TextBlock Text="Analysis Results"
                     Style="{StaticResource TitleTextBlockStyle}"/>

          <!-- Metadata -->
          <StackPanel Spacing="4">
            <TextBlock>
              <Run Text="Provider: " FontWeight="SemiBold"/>
              <Run Text="{x:Bind ViewModel.Result.ProviderUsed, Mode=OneWay}"/>
            </TextBlock>
            <TextBlock>
              <Run Text="Confidence: " FontWeight="SemiBold"/>
              <Run Text="{x:Bind ViewModel.Result.Confidence, Mode=OneWay}"/>
            </TextBlock>
            <TextBlock>
              <Run Text="Generated: " FontWeight="SemiBold"/>
              <Run Text="{x:Bind ViewModel.Result.GeneratedAtFormatted, Mode=OneWay}"/>
            </TextBlock>
          </StackPanel>

          <!-- Summary -->
          <StackPanel Spacing="8">
            <TextBlock Text="Summary" Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderThickness="1"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    CornerRadius="4"
                    Padding="12">
              <TextBlock Text="{x:Bind ViewModel.Result.Summary, Mode=OneWay}"
                         TextWrapping="Wrap"/>
            </Border>
          </StackPanel>

          <!-- Analysis -->
          <StackPanel Spacing="8">
            <TextBlock Text="Detailed Analysis" Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderThickness="1"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    CornerRadius="4"
                    Padding="12">
              <TextBlock Text="{x:Bind ViewModel.Result.Analysis, Mode=OneWay}"
                         TextWrapping="Wrap"/>
            </Border>
          </StackPanel>

          <!-- Recommendations -->
          <StackPanel Spacing="8">
            <TextBlock Text="Recommendations" Style="{StaticResource SubtitleTextBlockStyle}"/>
            <ItemsRepeater ItemsSource="{x:Bind ViewModel.Result.Recommendations, Mode=OneWay}">
              <ItemsRepeater.ItemTemplate>
                <DataTemplate x:DataType="models:RecommendationItem">
                  <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                          BorderThickness="1"
                          CornerRadius="4"
                          Padding="12"
                          Margin="0,0,0,12">
                    <StackPanel Spacing="8">
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="Auto"/>
                          <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0"
                                Background="{x:Bind Priority, Converter={StaticResource PriorityToBrushConverter}}"
                                CornerRadius="3"
                                Padding="8,4"
                                Margin="0,0,10,0">
                          <TextBlock Text="{x:Bind Priority}"
                                     Foreground="White"
                                     FontWeight="SemiBold"
                                     FontSize="12"/>
                        </Border>
                        <TextBlock Grid.Column="1"
                                   Text="{x:Bind Action}"
                                   FontWeight="SemiBold"
                                   TextWrapping="Wrap"
                                   VerticalAlignment="Center"/>
                      </Grid>
                      <StackPanel Spacing="4">
                        <StackPanel Spacing="2">
                          <TextBlock TextWrapping="Wrap">
                            <Run Text="Reasoning: " FontWeight="SemiBold"/>
                            <Run Text="{x:Bind Reasoning}"/>
                          </TextBlock>
                          <TextBlock FontSize="11"
                                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                     Visibility="{x:Bind HasReferenceLink, Mode=OneWay}">
                            <Hyperlink NavigateUri="{x:Bind ReferenceLink}">
                              <Run Text="{x:Bind ReferenceLink}"/>
                            </Hyperlink>
                          </TextBlock>
                        </StackPanel>
                        <TextBlock TextWrapping="Wrap">
                          <Run Text="Context: " FontWeight="SemiBold"/>
                          <Run Text="{x:Bind Context}"/>
                        </TextBlock>
                      </StackPanel>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
            </StackPanel>
          </StackPanel>
        </ScrollViewer>

      <!-- Empty State -->
      <StackPanel Grid.Column="1"
                  VerticalAlignment="Center"
                  HorizontalAlignment="Center"
                  Spacing="10"
                  Visibility="{x:Bind ViewModel.Result, Mode=OneWay, Converter={StaticResource InverseNullToVisibilityConverter}}">
        <TextBlock Text="No analysis results yet"
                   Style="{StaticResource SubtitleTextBlockStyle}"
                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                   HorizontalAlignment="Center"/>
        <TextBlock Text="Select an image and click 'Analyze Screenshot' to begin"
                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                   HorizontalAlignment="Center"/>
      </StackPanel>
    </Grid>
  </Grid>
</Page>
