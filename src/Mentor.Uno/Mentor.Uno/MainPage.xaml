<Page x:Class="Mentor.Uno.MainPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:Mentor.Uno"
      xmlns:models="using:Mentor.Core.Models"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
  
  <ScrollViewer>
    <Grid Margin="20">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- Input Section -->
      <StackPanel Grid.Row="0" Spacing="16" Margin="0,0,0,20">
        <Grid>
          <TextBlock Text="Screenshot Analysis" 
                     Style="{StaticResource TitleTextBlockStyle}"
                     HorizontalAlignment="Left"/>
          <Button Content="⚙ Settings" 
                  Click="OnSettingsClick"
                  HorizontalAlignment="Right"
                  Style="{StaticResource TextBlockButtonStyle}"/>
        </Grid>

        <!-- Image Selection -->
        <StackPanel Spacing="8">
          <TextBlock Text="Screenshot Image:" FontWeight="SemiBold"/>
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBox Grid.Column="0" 
                     Text="{x:Bind ViewModel.ImagePath, Mode=OneWay}"
                     PlaceholderText="Select an image file..."
                     IsReadOnly="True"
                     Margin="0,0,10,0"/>
            <Button Grid.Column="1" 
                    Content="Browse..."
                    Click="OnBrowseClick"
                    MinWidth="100"/>
          </Grid>
        </StackPanel>

        <!-- Prompt Input -->
        <StackPanel Spacing="8">
          <TextBlock Text="Analysis Prompt:" FontWeight="SemiBold"/>
          <TextBox Text="{x:Bind ViewModel.Prompt, Mode=TwoWay}"
                   PlaceholderText="What should I do next?"
                   AcceptsReturn="True"
                   MinHeight="60"
                   TextWrapping="Wrap"/>
        </StackPanel>

        <!-- Provider Selection -->
        <StackPanel Spacing="8">
          <TextBlock Text="LLM Provider:" FontWeight="SemiBold"/>
          <ComboBox ItemsSource="{x:Bind ViewModel.Providers}"
                    SelectedItem="{x:Bind ViewModel.SelectedProvider, Mode=TwoWay}"
                    MinWidth="200"
                    HorizontalAlignment="Left"/>
        </StackPanel>

        <!-- Analyze Button -->
        <Button Content="Analyze Screenshot"
                Command="{x:Bind ViewModel.AnalyzeCommand}"
                HorizontalAlignment="Stretch"
                Style="{StaticResource AccentButtonStyle}"/>

        <!-- Progress Indicator -->
        <StackPanel Orientation="Horizontal" 
                    Spacing="10"
                    HorizontalAlignment="Center"
                    Visibility="{x:Bind ViewModel.IsAnalyzing, Mode=OneWay}">
          <ProgressRing IsActive="True" Width="20" Height="20"/>
          <TextBlock Text="Analyzing..." FontStyle="Italic"/>
        </StackPanel>

        <!-- Error Message -->
        <InfoBar IsOpen="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
                 Severity="Error"
                 Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"/>
      </StackPanel>

      <!-- Results Section -->
      <ScrollViewer Grid.Row="1" Visibility="{x:Bind ViewModel.Result, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
        <StackPanel Spacing="16">
          <TextBlock Text="Analysis Results" 
                     Style="{StaticResource TitleTextBlockStyle}"/>

          <!-- Metadata -->
          <StackPanel Spacing="4">
            <TextBlock>
              <Run Text="Provider: " FontWeight="SemiBold"/>
              <Run Text="{x:Bind ViewModel.Result.ProviderUsed, Mode=OneWay}"/>
            </TextBlock>
            <TextBlock>
              <Run Text="Confidence: " FontWeight="SemiBold"/>
              <Run Text="{x:Bind ViewModel.Result.Confidence, Mode=OneWay}"/>
            </TextBlock>
            <TextBlock>
              <Run Text="Generated: " FontWeight="SemiBold"/>
              <Run Text="{x:Bind ViewModel.Result.GeneratedAtFormatted, Mode=OneWay}"/>
            </TextBlock>
          </StackPanel>

          <!-- Summary -->
          <StackPanel Spacing="8">
            <TextBlock Text="Summary" Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderThickness="1"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    CornerRadius="4"
                    Padding="12">
              <TextBlock Text="{x:Bind ViewModel.Result.Summary, Mode=OneWay}"
                         TextWrapping="Wrap"/>
            </Border>
          </StackPanel>

          <!-- Analysis -->
          <StackPanel Spacing="8">
            <TextBlock Text="Detailed Analysis" Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderThickness="1"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    CornerRadius="4"
                    Padding="12">
              <TextBlock Text="{x:Bind ViewModel.Result.Analysis, Mode=OneWay}"
                         TextWrapping="Wrap"/>
            </Border>
          </StackPanel>

          <!-- Recommendations -->
          <StackPanel Spacing="8">
            <TextBlock Text="Recommendations" Style="{StaticResource SubtitleTextBlockStyle}"/>
            <ItemsRepeater ItemsSource="{x:Bind ViewModel.Result.Recommendations, Mode=OneWay}">
              <ItemsRepeater.ItemTemplate>
                <DataTemplate x:DataType="models:RecommendationItem">
                  <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                          BorderThickness="1"
                          CornerRadius="4"
                          Padding="12"
                          Margin="0,0,0,12">
                    <StackPanel Spacing="8">
                      <StackPanel Orientation="Horizontal" Spacing="10">
                        <Border Background="{x:Bind Priority, Converter={StaticResource PriorityToBrushConverter}}"
                                CornerRadius="3"
                                Padding="8,4">
                          <TextBlock Text="{x:Bind Priority}" 
                                     Foreground="White"
                                     FontWeight="SemiBold"
                                     FontSize="12"/>
                        </Border>
                        <TextBlock Text="{x:Bind Action}" 
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                      </StackPanel>
                      <StackPanel Spacing="4">
                        <TextBlock TextWrapping="Wrap">
                          <Run Text="Reasoning: " FontWeight="SemiBold"/>
                          <Run Text="{x:Bind Reasoning}"/>
                        </TextBlock>
                        <TextBlock TextWrapping="Wrap">
                          <Run Text="Context: " FontWeight="SemiBold"/>
                          <Run Text="{x:Bind Context}"/>
                        </TextBlock>
                      </StackPanel>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
          </StackPanel>
        </StackPanel>
      </ScrollViewer>

      <!-- Empty State -->
      <StackPanel Grid.Row="1"
                  VerticalAlignment="Center"
                  HorizontalAlignment="Center"
                  Spacing="10"
                  Visibility="{x:Bind ViewModel.Result, Mode=OneWay, Converter={StaticResource InverseNullToVisibilityConverter}}">
        <TextBlock Text="No analysis results yet" 
                   Style="{StaticResource SubtitleTextBlockStyle}"
                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                   HorizontalAlignment="Center"/>
        <TextBlock Text="Select an image and click 'Analyze Screenshot' to begin" 
                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                   HorizontalAlignment="Center"/>
      </StackPanel>
    </Grid>
  </ScrollViewer>
</Page>
