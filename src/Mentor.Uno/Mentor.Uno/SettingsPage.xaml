<Page x:Class="Mentor.Uno.SettingsPage"
      x:Name="PageRoot"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:Mentor.Uno"
      xmlns:vm="using:Mentor.Uno.ViewModels"
      xmlns:converters="using:Mentor.Uno.Converters"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

  <Page.Resources>
    <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
  </Page.Resources>

  <Grid>
    <!-- Settings Content -->
    <ScrollViewer Padding="20">
      <StackPanel Spacing="32">

        <!-- Header with Back Button -->
        <Grid>
          <Button Content="â† Back"
                  Click="OnBackClick"
                  Style="{StaticResource TextBlockButtonStyle}"
                  HorizontalAlignment="Left"/>
          <TextBlock Text="Settings"
                     Style="{StaticResource TitleTextBlockStyle}"
                     HorizontalAlignment="Center"/>
        </Grid>

        <!-- LLM Providers Section -->
        <StackPanel Spacing="16">
          <Grid>
            <TextBlock Text="LLM Providers"
                       Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Button Content="+ Add Provider"
                    Command="{x:Bind ViewModel.AddProviderCommand}"
                    HorizontalAlignment="Right"
                    Style="{StaticResource AccentButtonStyle}"/>
          </Grid>

          <ItemsRepeater ItemsSource="{x:Bind ViewModel.Providers, Mode=OneWay}">
            <ItemsRepeater.ItemTemplate>
              <DataTemplate x:DataType="vm:ProviderViewModel">
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,12">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/>
                      <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Spacing="12">
                      <!-- Name -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBox Header="Name"
                               Text="{x:Bind Name, Mode=TwoWay}"
                               Width="200"/>
                      </StackPanel>

                      <!-- Provider Type and Model -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <ComboBox Header="Provider Type"
                                  SelectedItem="{x:Bind ProviderType, Mode=TwoWay}"
                                  ItemsSource="{Binding ElementName=PageRoot, Path=DataContext.AvailableProviderTypes}"
                                  Width="200"/>
                        <TextBox Header="Model"
                                 Text="{x:Bind Model, Mode=TwoWay}"
                                 Width="200"/>
                      </StackPanel>

                      <!-- Base URL -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBox Header="Base URL"
                               Text="{x:Bind BaseUrl, Mode=TwoWay}"
                               Width="420"/>
                      </StackPanel>

                      <!-- API Key and Timeout -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <PasswordBox Header="API Key"
                                     Password="{x:Bind ApiKey, Mode=TwoWay}"
                                     Width="300"/>
                        <TextBox Header="Timeout (seconds)"
                                 Text="{x:Bind Timeout, Mode=TwoWay}"
                                 Width="120"
                                 InputScope="Number"/>
                      </StackPanel>
                    </StackPanel>

                    <Button Grid.Column="1"
                            Content="Delete"
                            Command="{Binding ElementName=PageRoot, Path=DataContext.DeleteProviderCommand}"
                            CommandParameter="{x:Bind}"
                            VerticalAlignment="Top"
                            Style="{StaticResource TextBlockButtonStyle}"
                            Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsRepeater.ItemTemplate>
          </ItemsRepeater>
        </StackPanel>

        <!-- Web Search Tools Section -->
        <StackPanel Spacing="16">
          <Grid>
            <TextBlock Text="Web Search Tools"
                       Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Button Content="+ Add Tool"
                    Command="{x:Bind ViewModel.AddToolCommand}"
                    HorizontalAlignment="Right"
                    Style="{StaticResource AccentButtonStyle}"/>
          </Grid>

          <ItemsRepeater ItemsSource="{x:Bind ViewModel.Tools, Mode=OneWay}">
            <ItemsRepeater.ItemTemplate>
              <DataTemplate x:DataType="vm:ToolViewModel">
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,12">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/>
                      <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Spacing="12">
                      <!-- Tool Name -->
                      <TextBox Header="Tool Name"
                               Text="{x:Bind ToolName, Mode=TwoWay}"
                               Width="300"/>

                      <!-- Base URL -->
                      <TextBox Header="Base URL"
                               Text="{x:Bind BaseUrl, Mode=TwoWay}"
                               Width="420"/>

                      <!-- API Key and Timeout -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <PasswordBox Header="API Key"
                                     Password="{x:Bind ApiKey, Mode=TwoWay}"
                                     Width="300"/>
                        <TextBox Header="Timeout (seconds)"
                                 Text="{x:Bind Timeout, Mode=TwoWay}"
                                 Width="120"
                                 InputScope="Number"/>
                      </StackPanel>
                    </StackPanel>

                    <Button Grid.Column="1"
                            Content="Delete"
                            Command="{Binding ElementName=PageRoot, Path=DataContext.DeleteToolCommand}"
                            CommandParameter="{x:Bind}"
                            VerticalAlignment="Top"
                            Style="{StaticResource TextBlockButtonStyle}"
                            Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsRepeater.ItemTemplate>
          </ItemsRepeater>
        </StackPanel>

      </StackPanel>
    </ScrollViewer>

    <!-- Save Status Message Overlay (Bottom Right) -->
    <Border HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="20"
            Background="{ThemeResource SystemFillColorSuccessBackgroundBrush}"
            BorderBrush="{ThemeResource SystemFillColorSuccessBrush}"
            BorderThickness="1"
            Padding="16,12"
            CornerRadius="8"
            Visibility="{x:Bind ViewModel.IsSaveStatusVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
      <Border.Shadow>
        <ThemeShadow />
      </Border.Shadow>
      <StackPanel Orientation="Horizontal" Spacing="8">
        <FontIcon Glyph="&#xE73E;" 
                  FontSize="16"
                  Foreground="{ThemeResource SystemFillColorSuccessBrush}"/>
        <TextBlock Text="{x:Bind ViewModel.SaveStatusMessage, Mode=OneWay}"
                   Foreground="{ThemeResource SystemFillColorSuccessBrush}"
                   FontWeight="SemiBold"/>
      </StackPanel>
    </Border>

    <!-- Error Message Overlay (Bottom Right) -->
    <Border HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="20"
            Background="{ThemeResource SystemFillColorCriticalBackgroundBrush}"
            BorderBrush="{ThemeResource SystemFillColorCriticalBrush}"
            BorderThickness="1"
            Padding="16,12"
            CornerRadius="8"
            Visibility="{x:Bind ViewModel.IsErrorVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
      <Border.Shadow>
        <ThemeShadow />
      </Border.Shadow>
      <StackPanel Orientation="Horizontal" Spacing="8">
        <FontIcon Glyph="&#xE783;" 
                  FontSize="16"
                  Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
        <TextBlock Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                   Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                   FontWeight="SemiBold"
                   MaxWidth="400"
                   TextWrapping="Wrap"/>
      </StackPanel>
    </Border>
  </Grid>
</Page>

