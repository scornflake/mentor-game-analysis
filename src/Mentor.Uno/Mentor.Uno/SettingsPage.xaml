<Page x:Class="Mentor.Uno.SettingsPage"
      x:Name="PageRoot"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:Mentor.Uno"
      xmlns:vm="using:Mentor.Uno.ViewModels"
      xmlns:converters="using:Mentor.Uno.Converters"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

  <Page.Resources>
    <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
  </Page.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- Fixed Header with Back Button -->
    <Grid Grid.Row="0" Padding="20,20,20,12">
      <Button Content="â† Back"
              Click="OnBackClick"
              Style="{StaticResource TextBlockButtonStyle}"
              HorizontalAlignment="Left"/>
      <TextBlock Text="Settings"
                 Style="{StaticResource TitleTextBlockStyle}"
                 HorizontalAlignment="Center"/>
    </Grid>

    <!-- Scrollable Settings Content -->
    <ScrollViewer Grid.Row="1" Padding="20,12,20,20">
      <StackPanel Spacing="32">

        <!-- Global Settings Section -->
        <StackPanel Spacing="16">
          <TextBlock Text="Global Settings"
                     Style="{StaticResource SubtitleTextBlockStyle}"/>
          <TextBlock Text="Fixed providers and tools that can only have their API keys configured. Includes Perplexity, Brave Search, and Tavily Search."
                     FontSize="12"
                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                     Margin="0,0,0,8"/>
          
          <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                  BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="16">
            <StackPanel Spacing="16">
              
              <!-- Perplexity API Key -->
              <StackPanel Spacing="8">
                <TextBlock Text="Perplexity API Key" FontWeight="SemiBold"/>
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <PasswordBox Grid.Column="0"
                              Password="{x:Bind ViewModel.PerplexityApiKey, Mode=TwoWay}"
                              Visibility="{x:Bind ViewModel.IsPerplexityApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                  <TextBox Grid.Column="0"
                          Text="{x:Bind ViewModel.PerplexityApiKey, Mode=TwoWay}"
                          Visibility="{x:Bind ViewModel.IsPerplexityApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                  <Button Grid.Column="1"
                          Margin="8,0,0,0"
                          VerticalAlignment="Center"
                          Command="{x:Bind ViewModel.TogglePerplexityApiKeyVisibilityCommand}"
                          Style="{StaticResource TextBlockButtonStyle}"
                          Background="Transparent"
                          Padding="8"
                          MinWidth="40"
                          MinHeight="40">
                    <Grid>
                      <FontIcon Glyph="&#xE890;"
                               FontFamily="Segoe MDL2 Assets"
                               Visibility="{x:Bind ViewModel.IsPerplexityApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                      <FontIcon Glyph="&#xE7C8;"
                               FontFamily="Segoe MDL2 Assets"
                               Visibility="{x:Bind ViewModel.IsPerplexityApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                  </Button>
                </Grid>
              </StackPanel>

              <!-- Brave API Key -->
              <StackPanel Spacing="8">
                <TextBlock Text="Brave Search API Key" FontWeight="SemiBold"/>
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <PasswordBox Grid.Column="0"
                              Password="{x:Bind ViewModel.BraveApiKey, Mode=TwoWay}"
                              Visibility="{x:Bind ViewModel.IsBraveApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                  <TextBox Grid.Column="0"
                          Text="{x:Bind ViewModel.BraveApiKey, Mode=TwoWay}"
                          Visibility="{x:Bind ViewModel.IsBraveApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                  <Button Grid.Column="1"
                          Margin="8,0,0,0"
                          VerticalAlignment="Center"
                          Command="{x:Bind ViewModel.ToggleBraveApiKeyVisibilityCommand}"
                          Style="{StaticResource TextBlockButtonStyle}"
                          Background="Transparent"
                          Padding="8"
                          MinWidth="40"
                          MinHeight="40">
                    <Grid>
                      <FontIcon Glyph="&#xE890;"
                               FontFamily="Segoe MDL2 Assets"
                               Visibility="{x:Bind ViewModel.IsBraveApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                      <FontIcon Glyph="&#xE7C8;"
                               FontFamily="Segoe MDL2 Assets"
                               Visibility="{x:Bind ViewModel.IsBraveApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                  </Button>
                </Grid>
              </StackPanel>

              <!-- Tavily API Key -->
              <StackPanel Spacing="8">
                <TextBlock Text="Tavily Search API Key" FontWeight="SemiBold"/>
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <PasswordBox Grid.Column="0"
                              Password="{x:Bind ViewModel.TavilyApiKey, Mode=TwoWay}"
                              Visibility="{x:Bind ViewModel.IsTavilyApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                  <TextBox Grid.Column="0"
                          Text="{x:Bind ViewModel.TavilyApiKey, Mode=TwoWay}"
                          Visibility="{x:Bind ViewModel.IsTavilyApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                  <Button Grid.Column="1"
                          Margin="8,0,0,0"
                          VerticalAlignment="Center"
                          Command="{x:Bind ViewModel.ToggleTavilyApiKeyVisibilityCommand}"
                          Style="{StaticResource TextBlockButtonStyle}"
                          Background="Transparent"
                          Padding="8"
                          MinWidth="40"
                          MinHeight="40">
                    <Grid>
                      <FontIcon Glyph="&#xE890;"
                               FontFamily="Segoe MDL2 Assets"
                               Visibility="{x:Bind ViewModel.IsTavilyApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                      <FontIcon Glyph="&#xE7C8;"
                               FontFamily="Segoe MDL2 Assets"
                               Visibility="{x:Bind ViewModel.IsTavilyApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                  </Button>
                </Grid>
              </StackPanel>

            </StackPanel>
          </Border>
        </StackPanel>

        <!-- Export Settings Section -->
        <StackPanel Spacing="16">
          <TextBlock Text="Export Settings"
                     Style="{StaticResource SubtitleTextBlockStyle}"/>
          <TextBlock Text="Configure automatic export of analysis results to HTML files."
                     FontSize="12"
                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                     Margin="0,0,0,8"/>
          
          <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                  BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="16">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              
              <ToggleSwitch Grid.Column="0"
                            Header="Save Automatically"
                            IsOn="{x:Bind ViewModel.SaveAnalysisAutomatically, Mode=TwoWay}"
                            ToolTipService.ToolTip="When enabled, analysis results will be automatically exported to HTML files in Documents/Mentor/Saved Analysis after each successful analysis."/>
              
              <Button Grid.Column="1"
                      Command="{x:Bind ViewModel.OpenSaveFolderCommand}"
                      VerticalAlignment="Center"
                      ToolTipService.ToolTip="Opens the folder where analysis results are saved (Documents/Mentor/Saved Analysis)">
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <FontIcon Glyph="&#xE8B7;" FontSize="16"/>
                  <TextBlock Text="Open Save Folder"/>
                </StackPanel>
              </Button>
            </Grid>
          </Border>
        </StackPanel>

        <!-- LLM Providers Section -->
        <StackPanel Spacing="16">
          <Grid>
            <TextBlock Text="LLM Providers"
                       Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Button Content="+ Add Provider"
                    Command="{x:Bind ViewModel.AddProviderCommand}"
                    HorizontalAlignment="Right"
                    Style="{StaticResource AccentButtonStyle}"/>
          </Grid>

          <ItemsRepeater ItemsSource="{x:Bind ViewModel.Providers, Mode=OneWay}">
            <ItemsRepeater.ItemTemplate>
              <DataTemplate x:DataType="vm:ProviderViewModel">
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,12">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/>
                      <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Spacing="12">
                      <!-- Name -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBox Header="Name"
                               Text="{x:Bind Name, Mode=TwoWay}"
                               Width="200"/>
                      </StackPanel>

                      <!-- Provider Type and Model -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <ComboBox Header="Provider Type"
                                  SelectedItem="{x:Bind ProviderType, Mode=TwoWay}"
                                  ItemsSource="{Binding ElementName=PageRoot, Path=DataContext.AvailableProviderTypes}"
                                  Width="200"/>
                        <TextBox Header="Model"
                                 Text="{x:Bind Model, Mode=TwoWay}"
                                 Width="200"/>
                      </StackPanel>

                      <!-- Base URL -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBox Header="Base URL"
                               Text="{x:Bind BaseUrl, Mode=TwoWay}"
                               Width="420"/>
                      </StackPanel>

                      <!-- API Key and Timeout -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <Grid Width="300">
                          <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                          </Grid.ColumnDefinitions>
                          <PasswordBox Grid.Column="0"
                                      Header="API Key"
                                      Password="{x:Bind ApiKey, Mode=TwoWay}"
                                      Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                          <TextBox Grid.Column="0"
                                  Header="API Key"
                                  Text="{x:Bind ApiKey, Mode=TwoWay}"
                                  Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                          <Button Grid.Column="1"
                                  Margin="8,0,0,0"
                                  VerticalAlignment="Bottom"
                                  Command="{x:Bind ToggleApiKeyVisibilityCommand}"
                                  Style="{StaticResource TextBlockButtonStyle}"
                                  Background="Transparent"
                                  Padding="8"
                                  MinWidth="40"
                                  MinHeight="40">
                            <Grid>
                              <FontIcon Glyph="&#xE890;"
                                       FontFamily="Segoe MDL2 Assets"
                                       Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                              <FontIcon Glyph="&#xE7C8;"
                                       FontFamily="Segoe MDL2 Assets"
                                       Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </Grid>
                          </Button>
                        </Grid>
                        <TextBox Header="Timeout (seconds)"
                                 Text="{x:Bind Timeout, Mode=TwoWay}"
                                 Width="120"
                                 InputScope="Number"/>
                      </StackPanel>

                      <!-- RAG and MCP Search Options -->
                      <StackPanel Orientation="Horizontal" 
                                  Spacing="12">
                        <CheckBox Content="Retrieval Augmented Generation (RAG)"
                                  IsChecked="{x:Bind RetrievalAugmentedGeneration, Mode=TwoWay}"
                                  IsEnabled="{x:Bind IsRetrievalAugmentedGenerationEnabled, Mode=OneWay}"
                                  ToolTipService.ToolTip="If enabled, searches and reads articles before analysis. If disabled, LLM decides when to use search tools."/>
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" 
                                  Spacing="12">
                        <CheckBox Content="Server has MCP Search"
                                  IsChecked="{x:Bind ServerHasMcpSearch, Mode=TwoWay}"
                                  ToolTipService.ToolTip="If enabled, skips setting up local web search tools and expects the LLM server to have MCP search capability. Overrides RAG setting."/>
                      </StackPanel>
                    </StackPanel>

                    <Button Grid.Column="1"
                            Content="Delete"
                            Command="{Binding ElementName=PageRoot, Path=DataContext.DeleteProviderCommand}"
                            CommandParameter="{x:Bind}"
                            VerticalAlignment="Top"
                            Style="{StaticResource TextBlockButtonStyle}"
                            Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsRepeater.ItemTemplate>
          </ItemsRepeater>
        </StackPanel>

        <!-- Web Search Tools Section -->
        <StackPanel Spacing="16" Visibility="Collapsed">
          <Grid>
            <TextBlock Text="Web Search Tools"
                       Style="{StaticResource SubtitleTextBlockStyle}"/>
            <Button Content="+ Add Tool"
                    Command="{x:Bind ViewModel.AddToolCommand}"
                    HorizontalAlignment="Right"
                    Style="{StaticResource AccentButtonStyle}"/>
          </Grid>

          <ItemsRepeater ItemsSource="{x:Bind ViewModel.Tools, Mode=OneWay}">
            <ItemsRepeater.ItemTemplate>
              <DataTemplate x:DataType="vm:ToolViewModel">
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,12">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/>
                      <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Spacing="12">
                      <!-- Tool Name -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBox Header="Tool Name"
                                   Text="{x:Bind ToolName, Mode=TwoWay}"
                                   Width="300"/>
                      </StackPanel>

                      <!-- Base URL -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBox Header="Base URL"
                                   Text="{x:Bind BaseUrl, Mode=TwoWay}"
                                   Width="420"/>
                      </StackPanel>

                      <!-- API Key and Timeout -->
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <Grid Width="300">
                          <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                          </Grid.ColumnDefinitions>
                          <PasswordBox Grid.Column="0"
                                      Header="API Key"
                                      Password="{x:Bind ApiKey, Mode=TwoWay}"
                                      Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                          <TextBox Grid.Column="0"
                                  Header="API Key"
                                  Text="{x:Bind ApiKey, Mode=TwoWay}"
                                  Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                          <Button Grid.Column="1"
                                  Margin="8,0,0,0"
                                  VerticalAlignment="Bottom"
                                  Command="{x:Bind ToggleApiKeyVisibilityCommand}"
                                  Style="{StaticResource TextBlockButtonStyle}"
                                  Background="Transparent"
                                  Padding="8"
                                  MinWidth="40"
                                  MinHeight="40">
                            <Grid>
                              <FontIcon Glyph="&#xE890;"
                                       FontFamily="Segoe MDL2 Assets"
                                       Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                              <FontIcon Glyph="&#xE7C8;"
                                       FontFamily="Segoe MDL2 Assets"
                                       Visibility="{x:Bind IsApiKeyVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </Grid>
                          </Button>
                        </Grid>
                        <TextBox Header="Timeout (seconds)"
                                 Text="{x:Bind Timeout, Mode=TwoWay}"
                                 Width="120"
                                 InputScope="Number"/>
                      </StackPanel>
                    </StackPanel>

                    <Button Grid.Column="1"
                            Content="Delete"
                            Command="{Binding ElementName=PageRoot, Path=DataContext.DeleteToolCommand}"
                            CommandParameter="{x:Bind}"
                            VerticalAlignment="Top"
                            Style="{StaticResource TextBlockButtonStyle}"
                            Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsRepeater.ItemTemplate>
          </ItemsRepeater>
        </StackPanel>

      </StackPanel>
    </ScrollViewer>

    <!-- Save Status Message Overlay (Bottom Right) -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="20"
            Background="{ThemeResource SystemFillColorSuccessBackgroundBrush}"
            BorderBrush="{ThemeResource SystemFillColorSuccessBrush}"
            BorderThickness="1"
            Padding="16,12"
            CornerRadius="8"
            Visibility="{x:Bind ViewModel.IsSaveStatusVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
      <Border.Shadow>
        <ThemeShadow />
      </Border.Shadow>
      <StackPanel Orientation="Horizontal" Spacing="8">
        <FontIcon Glyph="&#xE73E;"
                  FontSize="16"
                  Foreground="{ThemeResource SystemFillColorSuccessBrush}"/>
        <TextBlock Text="{x:Bind ViewModel.SaveStatusMessage, Mode=OneWay}"
                   Foreground="{ThemeResource SystemFillColorSuccessBrush}"
                   FontWeight="SemiBold"/>
      </StackPanel>
    </Border>

    <!-- Error Message Overlay (Bottom Right) -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="20"
            Background="{ThemeResource SystemFillColorCriticalBackgroundBrush}"
            BorderBrush="{ThemeResource SystemFillColorCriticalBrush}"
            BorderThickness="1"
            Padding="16,12"
            CornerRadius="8"
            Visibility="{x:Bind ViewModel.IsErrorVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
      <Border.Shadow>
        <ThemeShadow />
      </Border.Shadow>
      <StackPanel Orientation="Horizontal" Spacing="8">
        <FontIcon Glyph="&#xE783;"
                  FontSize="16"
                  Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
        <TextBlock Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                   Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                   FontWeight="SemiBold"
                   MaxWidth="400"
                   TextWrapping="Wrap"/>
        <Button Content="Copy"
                Click="OnCopyErrorMessageClick"
                Style="{StaticResource TextBlockButtonStyle}"
                Padding="8,4"
                Margin="8,0,0,0"
                VerticalAlignment="Center"/>
      </StackPanel>
    </Border>
  </Grid>
</Page>

